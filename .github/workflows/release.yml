name: Release

on:
  push:
    branches: [main]

  workflow_dispatch:
    inputs:
      release_type:
        description: "Release type"
        required: true
        type: choice
        options: [patch, minor, major]

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    if: "!startsWith(github.event.head_commit.message, 'chore(release):')"

    permissions:
      contents: write

    outputs:
      version: ${{ steps.release.outputs.version }}
      tag: ${{ steps.release.outputs.tag }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.CI_CD_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install

      - name: Install python-semantic-release
        run: uv tool install python-semantic-release

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # Ensure push uses the same token as checkout (GITHUB_TOKEN = bypass as Integration)
      - name: Set remote URL for push
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.CI_CD_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Get current version
        id: current
        run: |
          CURRENT_VERSION=$(grep -Po '(?<=^version = ")[^"]*' pyproject.toml)
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Current version: $CURRENT_VERSION"

      - name: Run Semantic Release
        id: release
        env:
          GH_TOKEN: ${{ secrets.CI_CD_TOKEN }}
        run: |
          EVENT="${{ github.event_name }}"
          RELEASE_TYPE="${{ inputs.release_type }}"

          if [ "$EVENT" == "workflow_dispatch" ]; then
            echo "ðŸš€ Creating stable $RELEASE_TYPE release..."

            semantic-release version --$RELEASE_TYPE --no-push

            NEW_VERSION=$(grep -Po '(?<=^version = ")[^"]*' pyproject.toml)
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "is_stable=true" >> $GITHUB_OUTPUT

            git push
            git push --tags

            echo "âœ… Released version: $NEW_VERSION"
          else
            echo "ðŸ”„ Creating release candidate..."

            semantic-release version --prerelease --no-push

            NEW_VERSION=$(grep -Po '(?<=^version = ")[^"]*' pyproject.toml)
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "is_stable=false" >> $GITHUB_OUTPUT

            git push

            echo "âœ… Created RC: $NEW_VERSION"
          fi

      - name: Create GitHub Release (stable only)
        if: steps.release.outputs.is_stable == 'true'
        env:
          GH_TOKEN: ${{ secrets.CI_CD_TOKEN }}
        run: |
          TAG="${{ steps.release.outputs.tag }}"
          VERSION="${{ steps.release.outputs.version }}"

          gh release create "$TAG" \
            --title "Release $VERSION" \
            --generate-notes

          echo "âœ… Created GitHub Release: $TAG"

      - name: Summary
        run: |
          echo "## ðŸ“¦ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Previous | \`${{ steps.current.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| New | \`${{ steps.release.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.release.outputs.is_stable }}" == "true" ]; then
            echo "| Type | ðŸš€ Stable Release |" >> $GITHUB_STEP_SUMMARY
            echo "| Tag | \`${{ steps.release.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— https://github.com/${{ github.repository }}/releases/tag/${{ steps.release.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Type | ðŸ”„ Release Candidate |" >> $GITHUB_STEP_SUMMARY
          fi